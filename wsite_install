#!/bin/bash

###########################
#
#  Укажите URL версии WordPress
#
##########################

new_wordpress_url="https://ru.wordpress.org/last-ru_RU.zip"

#########################

clear

echo -e "Вас привествует система установки и настройки виртуального хостинга\n"

if [ -f ".websitebuilding" ]; then 

echo "Установка системы уже произведена"
echo 
echo "Выход"
exit; fi

echo -n "Укажите базовый домен вашего сервера, например, ya.ru: "

read domain

echo 

echo -n "Укажите пароль для базы данных: "

while IFS= read -p "$prompt" -r -s -n 1 char

do
    # Enter - accept password
    if [[ $char == $'\0' ]] ; then
        break
    fi
    # Backspace
    if [[ $char == $'\177' ]] ; then
        prompt=$'\b \b'
        password="${password%?}"
    else
        prompt='*'
        password+="$char"
    fi
done

echo

echo "Базовый сайт будет располагаться по адресу http://$domain"

echo "Студенческие сайты будут располагаться по адресу http://studentname.$domain"

exit

sudo apt-get -y install mc lynx man proftpd htop zip unzip ca-certificates apache2 

sudo apt-get -y install mysql-client mysql-server php7.0 php7.0-fpm php7.0-gd php7.0-mysql php7.0-curl php7.0-json 

sudo apr-get -y install php7.0-mbstring php7.0-xml memcached php-memcache 

sudo cp /etc/apache2/conf-available/charset.conf{,.bak}  

sudo sh -c "sed -e 's/#AddDefaultCharset UTF-8/AddDefaultCharset UTF-8/' /etc/apache2/conf-available/charset.conf > /etc/apache2/conf-available/charset.conf.new" 

sudo mv /etc/apache2/conf-available/charset.conf{.new,} 

sudo a2enmod proxy_fcgi setenvif 

sudo a2enconf php7.0-fpm 

cd 

wget $new_wordpress_url 

unzip last-ru_RU.zip 

rm -f last-ru_RU.zip 

wget https://raw.githubusercontent.com/koo2018/websitebuilding/master/newstudent

wget https://raw.githubusercontent.com/koo2018/websitebuilding/master/delstudent 

wget https://raw.githubusercontent.com/koo2018/websitebuilding/master/tarbkp 

wget https://raw.githubusercontent.com/koo2018/websitebuilding/master/zipbkp 

chmod 700 ./newstudent

chmod 700 ./delstudent

chmod 700 ./tarbkp 

chmod 700 ./zipbkp 

clear 

echo -e "\ny\n1234\n1234\ny\ny\ny\ny" | sudo /usr/bin/mysql_secure_installation

echo -e "use mysql; update user set plugin='' where User='root'; flush privileges;" | sudo mysql 

sudo cp /etc/ssh/sshd_config{,.bak} 

sudo sh -c "sed -e 's/PermitRootLogin yes/PermitRootLogin no/' /etc/ssh/sshd_config > /etc/ssh/sshd_config.new"

sudo mv /etc/ssh/sshd_config{.new,} 

sudo cp  /etc/mysql/mariadb.conf.d/50-server.cnf{,.bak} 

sudo sh -c "sed -e 's/#max_connections/max_connections/' /etc/mysql/mariadb.conf.d/50-server.cnf > /etc/mysql/mariadb.conf.d/50-server.cnf.new"

sudo mv /etc/mysql/mariadb.conf.d/50-server.cnf{.new,} 

sudo sh -c "sed -e 's/max_connections        = 100/max_connections        = 200/' /etc/mysql/mariadb.conf.d/50-server.cnf > /etc/mysql/mariadb.conf.d/50-server.cnf.new" 

sudo mv /etc/mysql/mariadb.conf.d/50-server.cnf{.new,} && sudo cp  /etc/php/7.0/fpm/php.ini{,.bak} 

sudo sh -c "sed -e 's/upload_max_filesize = 2M/upload_max_filesize = 50M/' /etc/php/7.0/fpm/php.ini > /etc/php/7.0/fpm/php.ini.new"

sudo mv /etc/php/7.0/fpm/php.ini{.new,}  

echo -e ' # Generated by NOT /usr/bin/select-editor\nSELECTED_EDITOR="/usr/bin/mcedit"' > .selected_editor 

echo -e '\n\n EVERYTHING IS DONE. REBOOTING . . . \n\n DO NOT FOREGET TO DROP IN AGAIN \n\n JUST TYPE TWO EXCLAMATION MARKS\n\n !!\n\n' 

touch .websitebuilding

sudo reboot now
