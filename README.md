# Автоматизация установки и настройки учебного хостинга

Этот набор скриптов автоматизирует установку и настройку хостинга и устанавливает на него последнюю версию CMS WordPress. Скрипты рассчитаны на работу с Debian 9.

Скрипты были написаны для того, чтобы автоматизировать работу с учебным хостингом в рамках курса по сайтостроению и WordPress.

## Установка

1. Установите свежий инстанс Debian 9 на VPS/VDS хостинг.
2. Под пользователем ***root*** скопируйте в командную строку содержимое файла [under_root](https://raw.githubusercontent.com/koo2018/websitebuilding/master/under_root). Этот скрипт создаст пользователя ***teacher*** и попросит установить ему пароль.
3. Выйдите из системы и вернитесь под пользователем ***teacher***
4. Скачайте скрипт [wsite_install](https://raw.githubusercontent.com/koo2018/websitebuilding/master/wsite_install), например, командой 
```bash

wget https://raw.githubusercontent.com/koo2018/websitebuilding/master/wsite_install

```
5. Сделайте скрипт исполняемым и нечитаемым никем, кроме пользователя - все-таки там пароль от MySQL в открытом виде :unamused:
```bash

chmod 700 ./wsite_install

```
6. Запустите его. Надо будет указать основной домен вашего сервера, пароль администратора MySQL, а также стандартный пароль, который получат пользователи по умолчанию.
7. Скрипт установит все пакеты, скачает WordPress, скачает и настроит скрипты автоматизации создния пользовательских аккаунтов. По завершению работы скрипт удалит сам себя и перезагрузит сервер. Вернитесь и начинайте работу с аккаунтами пользователей/студентов. 


## Что будет после установки

В результате работы скрипта [wsite_install](https://raw.githubusercontent.com/koo2018/websitebuilding/master/wsite_install) в директории появится несколько файлов
* **delstudent** - скрипт удаление пользовательского/студенческого аккаунта
* **newstudent** - скрипт создания пользовательского/студенческого аккаунта  
* **tarbkp** - скрипт бэкапа пользовательских/студенческих аккаунтов архиватором tar+gzip     
* **zipbkp** - скрипт бэкапа пользовательских/студенческих аккаунтов архиватором zip
* **.websitebuilding** - файл-метка, что система уже истановлена, чтобы случайной переустановкой не поломать настройки. Лучше его не трогать


## Создание пользовательского/студенческого аккаунта

## Создание сайта на WordPress

## Удаление пользовательского/студенческого аккаунта

## Смена паролей

### Студент забыл пароль от хостинга/FTP

Тут все просто. Надо просто под рутом установить новый пароль

```bash
sudo passwd <studentName>
``` 

### Студент забыл пароль от своего сайта на WordPress

Здесь все несколько сложнее. Тем не менее, существует несколько способов поменять пароль пользователя сайта на WordPress. Мы сделаем это для пользователя editor админки wordpress через клиентскую программу MySQL. Набираем в командной строке:

```bash
mysql -uroot -p -hlocalhost
```

и после введения пароля попадаем в среду работы с базой данных MariaDB/MySQL. Сначала нам надо переключиться в базу данных этого забывчивого студента, которому мы меняем пароль (точка с запятой в конце важна):

```mysql
USE tester01;
```

Смотрим, есть ли вообще такой пользователь его админки, которому студент хочет поменять пароль.

```mysql
SELECT user_login FROM wp_users;
```

Видим, что есть.


Меняем пароль на 54321, предварительно зашифровав его алгоритмом md5, как того требует WordPress:

```mysql
UPDATE wp_users SET user_pass = MD5('54321') WHERE user_login = 'editor';
```

Если ваш пользователь админки не editor или вы хотите другой пароль, внесите соответствующие изменения в последнюю команду.


## Бэкап системы
Установочный скрипт скачал, записал и настроил две утилиты для архивирования **tarbkp** и **zipbkp**, котрые делают бэкап при помощи арзиваторов tar+gzip и zip, соответственно. Решение с tar и gzip работает существенно быстрее и сжимает лучше процентов на пять. Оба этих скрипта работают одинаково. Они создают в домашней директории пользователя **teacher** папку **backups** и складывают туда в сжатом виде студенческие директории и дамп **mysql**. Получается файл, в названии которого текущая дата, a расширение .tgz или .zip, в зависимости от расширения. Например, 2018-11-04.zip или 2018-11-04.tgz. Причем, скрипт бэкапа сотрет файлы старше 14 дней в папке backups, чтобы не засорять диск.

Можно настроить систему, чтобы она автоматически «бэкапила» данные, например, по ночам. Для этого надо разместить задание в планировщике cron.

```cron
/usr/bin/crontab -e
```

Добавьте в конец файла следующую строку

```
30 6 * * * /home/teacher/tarbkp
```

Ее смысл таков: в 30 минут, 6 часов утра, каждый день месяца, каждый месяц, каждый день недели (* * * - об этом) выполни скрипт, который находится по пути **/home/teacher/tarbkp**. Вы можете назначить свой график.

Не забудьте нажать Enter после этой строки в файле – так требует cron.

